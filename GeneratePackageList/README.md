# GeneratePackageList

`GeneratePackageList` generates a `packagelist.make` file from a _loooong_ list of packages in `generatePackageArray.swift`. It also uses the `primary.sqlite` `yum` database to retrieve the `pkgId`s of the packages.

##Table Of Contents

<!--ts-->

-   [GeneratePackageList](#generatepackagelist)
    -   [Usage](#usage)
        -   [Getting primary.sqlite](#getting-primarysqlite)
        -   [Generating packagelist.make](#generating-packagelistmake)
    -   [Adding New Packages](#adding-new-packages)

<!-- Added by: lebje, at: Tue Mar  9 09:12:49 EST 2021 -->

<!--te-->

## Usage

### Getting `primary.sqlite`

This file is usually found at `/var/cache/yum/<arch>/2/amzn2-core/primary.sqlite.gz`, and is only available on Amazon Linux 2.
If you can't find it, run `sudo yum makecache fast`.

If you don't have a computer running Amazon Linux 2, you can use [Docker](https://docs.docker.com/get-docker/):

```bash
# Run the container in your current directory.
$ docker run --rm -v $(pwd):/src -w /src -it amazonlinux
bash-4.2# yum makecache fast
# Copy the file to the directory docker is running in.
cp /var/cache/yum/aarch64/2/amzn2-core/primary.sqlite.gz .
```

Once you have the file, un-archive it using `gzip`:

```bash
$ gzip -d path/to/primary.sqlite.gz
```

### Generating `packagelist.make`

Once you have the `primary.sqlite` file, you'll need to build `GeneratePackageList`: `swift build`.
Then use it:

```bash
$ /path/to/GeneratePackageList/.build/debug/GeneratePackageList /path/to/primary.sqlite <cpu-arch> > /path/to/packagelist.make
```

The output will look like this:

```makefile
# packagelist.make
#
# This file is generated by the code in GeneratePackageList - DO NOT EDIT
#
# Created by Helge Heß
# Copyright © 2020 ZeeZide GmbH. All rights reserved.
#
# OK, the `packages_files` is essentially the primary.sqlite.gz I suppose.
# Using this we could avoid the hardcoding of the package hashes:

# "${ALX_BLOBSTORE_URL}/d12a..1537ff7fb02e/glibc-devel-2.26-34.amzn2.x86_64.rpm"
PACKAGE_NAMES = \
10ba20673d3b4ea230ca095140b418f8cdc694b90b0e8021ff1eaa5d01e674ae/gcc-7.3.1-6.amzn2.0.4.x86_64.rpm \
74faca4ac8746c6369c6a701ca4f54e41bff4ce57c344a556042525a841d9046/gcc-c++-7.3.1-6.amzn2.0.4.x86_64.rpm \
94a0c31b245df60e9332606b2900d5620d0a6e32f769bd7bfde56bcc7721b1d4/libgcc-7.3.1-6.amzn2.0.4.x86_64.rpm \
7d952d019da52d2a612046739c84e0133e0aa83cd82317e0f77a15886ca7aed7/glibc-2.26-34.amzn2.x86_64.rpm \
a63e42333f4e0b51ff0b184024a6b9b3ccba204924d4f3098e0f3205c465442f/glibc-static-2.26-34.amzn2.x86_64.rpm \
...
```

Example:

```bash
$ ./GeneratePackageList/.build/debug/GeneratePackageList amazonlinux2/primary.sqlite x86_64 > amazonlinux2/packagelist.make
```

More Info:

`GeneratePackageList --help`

## Adding New Packages

Simply add the package's RPM filename to `packages.json`:

```json
[
   "zlib-1.2.7-18.amzn2.{ARCH}.rpm",
   ...
   // Your package here.
]
```

The package filename should follow the format of the others.

Then run `./generatePackageArray` to regenerate the Swift array of packages.

If you skipped packages when running `generatePackageArray`, be sure to add them in `Sources/GeneratePackageList/ExtraPackages.swift`:

```swift
func addExtraPackages() {
   packageList += [
      Package(
         name: "tzdata",
         version: "2019c",
         release: "1.amzn2"
      ),
      ...
      // Your package here.
   ]
}

```
